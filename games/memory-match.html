<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory Match - Mini Games Arcade</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .back-btn {
            color: #e94560;
            text-decoration: none;
            font-size: 1.5rem;
            padding: 10px 15px;
            border-radius: 10px;
            transition: background 0.2s;
        }

        .back-btn:hover {
            background: rgba(233, 69, 96, 0.2);
        }

        h1 {
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .setup-screen {
            background: rgba(255, 255, 255, 0.05);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            color: #fff;
            max-width: 400px;
            width: 100%;
        }

        .setup-screen h2 {
            margin-bottom: 30px;
            color: #e94560;
        }

        .setup-group {
            margin-bottom: 25px;
        }

        .setup-group label {
            display: block;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .option-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .option-btn {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid transparent;
            color: #fff;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
        }

        .option-btn:hover {
            background: rgba(233, 69, 96, 0.2);
        }

        .option-btn.selected {
            border-color: #e94560;
            background: rgba(233, 69, 96, 0.3);
        }

        .start-btn, .btn {
            padding: 15px 50px;
            font-size: 1.2rem;
            background: linear-gradient(145deg, #e94560, #c73e54);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .start-btn:hover, .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(233, 69, 96, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            padding: 12px 30px;
            font-size: 1rem;
        }

        .setup-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }

        .game-screen {
            display: none;
            flex-direction: column;
            align-items: center;
        }

        .game-screen.active {
            display: flex;
        }

        .players-bar {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }

        .player-info {
            padding: 15px 25px;
            border-radius: 10px;
            color: #fff;
            text-align: center;
            transition: all 0.3s;
            opacity: 0.5;
        }

        .player-info.active {
            opacity: 1;
            transform: scale(1.05);
        }

        .player-info.player1 {
            background: rgba(233, 69, 96, 0.3);
            border: 2px solid #e94560;
        }

        .player-info.player2 {
            background: rgba(59, 130, 246, 0.3);
            border: 2px solid #3b82f6;
        }

        .player-info .name {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .player-info .score {
            font-size: 1.5rem;
        }

        .turn-indicator {
            color: #fff;
            font-size: 1.2rem;
            margin-bottom: 15px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .turn-indicator.player1 { color: #e94560; }
        .turn-indicator.player2 { color: #3b82f6; }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            color: #fff;
            font-size: 1rem;
        }

        .stats span {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 16px;
            border-radius: 10px;
        }

        .game-board {
            display: grid;
            gap: 10px;
            perspective: 1000px;
        }

        .game-board.cols-4 { grid-template-columns: repeat(4, 1fr); }
        .game-board.cols-6 { grid-template-columns: repeat(6, 1fr); }

        .card {
            width: 80px;
            height: 80px;
            cursor: pointer;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.5s ease;
        }

        .game-board.cols-6 .card {
            width: 70px;
            height: 70px;
        }

        .card.flipped { transform: rotateY(180deg); }

        .card.matched { animation: matched 0.5s ease; }

        @keyframes matched {
            0%, 100% { transform: rotateY(180deg) scale(1); }
            50% { transform: rotateY(180deg) scale(1.1); }
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .game-board.cols-6 .card-face { font-size: 1.6rem; }

        .card-front {
            background: linear-gradient(145deg, #e94560, #c73e54);
            transform: rotateY(180deg);
        }

        .card-back {
            background: linear-gradient(145deg, #0f3460, #16213e);
            border: 2px solid #e94560;
        }

        .card-back::after {
            content: '?';
            color: #e94560;
            font-weight: bold;
        }

        .card:hover:not(.flipped):not(.matched) { transform: scale(1.05); }

        .card.matched.player1 .card-front { background: linear-gradient(145deg, #e94560, #c73e54); }
        .card.matched.player2 .card-front { background: linear-gradient(145deg, #3b82f6, #2563eb); }

        button.game-btn {
            margin-top: 20px;
            padding: 12px 30px;
            font-size: 1rem;
            background: linear-gradient(145deg, #e94560, #c73e54);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button.game-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(233, 69, 96, 0.4);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .modal.show { display: flex; }

        .modal-content {
            background: linear-gradient(145deg, #1a1a2e, #16213e);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            color: white;
            border: 2px solid #e94560;
            animation: popIn 0.3s ease;
            max-width: 450px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes popIn {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .modal-content h2 {
            font-size: 2rem;
            margin-bottom: 20px;
            color: #4ecca3;
        }

        .modal-content h2.player1-wins { color: #e94560; }
        .modal-content h2.player2-wins { color: #3b82f6; }

        .modal-content p {
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        .modal-content .score-summary {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 20px 0;
        }

        .modal-content .player-score {
            padding: 15px 25px;
            border-radius: 10px;
        }

        .modal-content .player-score.p1 { background: rgba(233, 69, 96, 0.3); }
        .modal-content .player-score.p2 { background: rgba(59, 130, 246, 0.3); }

        .modal-content .player-score .name {
            font-size: 1rem;
            margin-bottom: 5px;
        }

        .modal-content .player-score .score {
            font-size: 1.8rem;
            font-weight: bold;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .modal-buttons button {
            padding: 12px 25px;
            font-size: 1rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .modal-buttons button:hover { transform: translateY(-2px); }

        .modal-buttons .play-again {
            background: linear-gradient(145deg, #4ecca3, #3db892);
            color: white;
        }

        .modal-buttons .new-setup {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        /* Scoreboard Styles */
        .scoreboard-list {
            text-align: left;
            margin: 20px 0;
        }

        .scoreboard-list h3 {
            text-align: center;
            color: #e94560;
            margin-bottom: 15px;
        }

        .score-entry {
            display: flex;
            justify-content: space-between;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.05);
            margin-bottom: 5px;
            border-radius: 8px;
        }

        .score-entry.highlight {
            background: rgba(78, 204, 163, 0.2);
            border: 1px solid #4ecca3;
        }

        .score-entry .rank {
            color: #e94560;
            font-weight: bold;
            width: 30px;
        }

        .score-entry .player-name {
            flex: 1;
            color: #fff;
        }

        .score-entry .score-value {
            color: #4ecca3;
            font-weight: bold;
        }

        .name-input-section {
            margin: 20px 0;
        }

        .name-input-section input {
            padding: 12px 20px;
            font-size: 1.1rem;
            border: 2px solid #e94560;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            text-align: center;
            width: 200px;
        }

        .name-input-section input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .name-input-section p {
            margin-bottom: 10px;
            color: #4ecca3;
        }

        .no-scores {
            color: #888;
            font-style: italic;
            padding: 20px;
        }

        @media (max-width: 500px) {
            .card { width: 65px; height: 65px; }
            .game-board.cols-6 .card { width: 50px; height: 50px; }
            .card-face { font-size: 1.6rem; }
            .game-board.cols-6 .card-face { font-size: 1.2rem; }
            .game-board { gap: 8px; }
            .players-bar { flex-direction: column; gap: 10px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <a href="../index.html" class="back-btn">‚Üê</a>
        <h1>Memory Match</h1>
    </div>

    <!-- Setup Screen -->
    <div class="setup-screen" id="setupScreen">
        <h2>Game Setup</h2>

        <div class="setup-group">
            <label>Players</label>
            <div class="option-buttons">
                <button class="option-btn selected" data-players="1">1 Player</button>
                <button class="option-btn" data-players="2">2 Players</button>
            </div>
        </div>

        <div class="setup-group">
            <label>Difficulty</label>
            <div class="option-buttons">
                <button class="option-btn" data-level="easy">Easy (6 pairs)</button>
                <button class="option-btn selected" data-level="medium">Medium (8 pairs)</button>
                <button class="option-btn" data-level="hard">Hard (12 pairs)</button>
            </div>
        </div>

        <div class="setup-buttons">
            <button class="start-btn" id="startGameBtn">Start Game</button>
            <button class="btn btn-secondary" id="viewScoreboardBtn">View Scoreboard</button>
        </div>
    </div>

    <!-- Game Screen -->
    <div class="game-screen" id="gameScreen">
        <div class="players-bar" id="playersBar">
            <div class="player-info player1 active" id="player1Info">
                <div class="name">Player 1</div>
                <div class="score"><span id="player1Score">0</span> pairs</div>
            </div>
            <div class="player-info player2" id="player2Info" style="display: none;">
                <div class="name">Player 2</div>
                <div class="score"><span id="player2Score">0</span> pairs</div>
            </div>
        </div>

        <div class="turn-indicator player1" id="turnIndicator">Player 1's Turn</div>

        <div class="stats">
            <span>Time: <span id="time">0:00</span></span>
            <span>Pairs: <span id="pairs">0</span>/<span id="totalPairs">8</span></span>
        </div>

        <div class="game-board cols-4" id="gameBoard"></div>

        <button class="game-btn" id="newGameBtn">New Game</button>
    </div>

    <!-- Win Modal -->
    <div class="modal" id="winModal">
        <div class="modal-content">
            <h2 id="winTitle">You Win!</h2>
            <div class="score-summary" id="scoreSummary">
                <div class="player-score p1">
                    <div class="name">Player 1</div>
                    <div class="score" id="finalP1Score">0</div>
                </div>
                <div class="player-score p2" id="p2Summary" style="display: none;">
                    <div class="name">Player 2</div>
                    <div class="score" id="finalP2Score">0</div>
                </div>
            </div>
            <p>Time: <span id="finalTime"></span></p>

            <div class="name-input-section" id="nameInputSection" style="display: none;">
                <p>New High Score! Enter your name:</p>
                <input type="text" id="playerNameInput" placeholder="Your name" maxlength="15">
            </div>

            <div class="modal-buttons">
                <button class="play-again" id="playAgainBtn">Play Again</button>
                <button class="new-setup" id="newSetupBtn">Change Settings</button>
                <button class="new-setup" id="quitBtn">Quit</button>
            </div>
        </div>
    </div>

    <!-- Scoreboard Modal -->
    <div class="modal" id="scoreboardModal">
        <div class="modal-content">
            <h2>Scoreboard</h2>

            <div class="setup-group">
                <div class="option-buttons">
                    <button class="option-btn selected" data-sb-level="easy">Easy</button>
                    <button class="option-btn" data-sb-level="medium">Medium</button>
                    <button class="option-btn" data-sb-level="hard">Hard</button>
                </div>
            </div>

            <div class="scoreboard-list" id="scoreboardList"></div>

            <div class="modal-buttons">
                <button class="new-setup" id="closeScoreboardBtn">Close</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/supabase-config.js"></script>
    <script>
        const allEmojis = ['üéÆ', 'üé≤', 'üéØ', 'üé™', 'üé®', 'üé≠', 'üé∏', 'üé∫', 'üéª', 'üéπ', 'üé§', 'üéß'];

        const LEVELS = {
            easy: { pairs: 6, cols: 4, rows: 3 },
            medium: { pairs: 8, cols: 4, rows: 4 },
            hard: { pairs: 12, cols: 6, rows: 4 }
        };

        let config = { players: 1, level: 'medium' };
        let cards = [];
        let flippedCards = [];
        let matchedPairs = 0;
        let currentPlayer = 1;
        let scores = { 1: 0, 2: 0 };
        let gameStarted = false;
        let timerInterval;
        let seconds = 0;
        let canFlip = true;
        let totalPairs = 8;
        let pendingScore = null;

        function formatTime(secs) {
            const mins = Math.floor(secs / 60);
            const s = secs % 60;
            return `${mins}:${s.toString().padStart(2, '0')}`;
        }

        async function renderScoreboard(level) {
            const container = document.getElementById('scoreboardList');

            if (typeof getScoresFromDB !== 'function') {
                container.innerHTML = '<p class="no-scores">Scoreboard unavailable</p>';
                return;
            }

            container.innerHTML = '<p class="no-scores">Loading...</p>';
            const levelScores = await getScoresFromDB('memory_match', level);

            if (levelScores.length === 0) {
                container.innerHTML = '<p class="no-scores">No scores yet. Be the first!</p>';
                return;
            }

            let html = '<h3>Top 10 - ' + level.charAt(0).toUpperCase() + level.slice(1) + '</h3>';
            levelScores.forEach((entry, index) => {
                html += `
                    <div class="score-entry">
                        <span class="rank">#${index + 1}</span>
                        <span class="player-name">${entry.player_name}</span>
                        <span class="score-value">${formatTime(entry.score)}</span>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // Setup event listeners
        document.querySelectorAll('[data-players]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('[data-players]').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                config.players = parseInt(btn.dataset.players);
            });
        });

        document.querySelectorAll('[data-level]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('[data-level]').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                config.level = btn.dataset.level;
            });
        });

        document.querySelectorAll('[data-sb-level]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('[data-sb-level]').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                renderScoreboard(btn.dataset.sbLevel);
            });
        });

        document.getElementById('startGameBtn').addEventListener('click', startGame);
        document.getElementById('newGameBtn').addEventListener('click', () => initGame());

        document.getElementById('viewScoreboardBtn').addEventListener('click', () => {
            renderScoreboard('easy');
            document.querySelectorAll('[data-sb-level]').forEach(b => b.classList.remove('selected'));
            document.querySelector('[data-sb-level="easy"]').classList.add('selected');
            document.getElementById('scoreboardModal').classList.add('show');
        });

        document.getElementById('closeScoreboardBtn').addEventListener('click', () => {
            document.getElementById('scoreboardModal').classList.remove('show');
        });

        document.getElementById('playAgainBtn').addEventListener('click', async () => {
            await savePlayerScore();
            document.getElementById('winModal').classList.remove('show');
            initGame();
        });

        document.getElementById('newSetupBtn').addEventListener('click', async () => {
            await savePlayerScore();
            document.getElementById('winModal').classList.remove('show');
            document.getElementById('gameScreen').classList.remove('active');
            document.getElementById('setupScreen').style.display = 'block';
        });

        document.getElementById('quitBtn').addEventListener('click', async () => {
            await savePlayerScore();
            window.location.href = '../index.html';
        });

        async function savePlayerScore() {
            if (pendingScore && config.players === 1) {
                const nameInput = document.getElementById('playerNameInput');
                const name = nameInput.value.trim() || 'Anonymous';
                if (typeof addScoreToDB === 'function') {
                    await addScoreToDB('memory_match', name, pendingScore.time, pendingScore.level);
                }
                pendingScore = null;
                nameInput.value = '';
            }
        }

        function startGame() {
            document.getElementById('setupScreen').style.display = 'none';
            document.getElementById('gameScreen').classList.add('active');

            const p2Info = document.getElementById('player2Info');
            const p2Summary = document.getElementById('p2Summary');
            if (config.players === 2) {
                p2Info.style.display = 'block';
                p2Summary.style.display = 'block';
            } else {
                p2Info.style.display = 'none';
                p2Summary.style.display = 'none';
            }

            const level = LEVELS[config.level];
            const gameBoard = document.getElementById('gameBoard');
            gameBoard.className = 'game-board cols-' + level.cols;

            initGame();
        }

        function initGame() {
            const level = LEVELS[config.level];
            totalPairs = level.pairs;

            cards = [];
            flippedCards = [];
            matchedPairs = 0;
            currentPlayer = 1;
            scores = { 1: 0, 2: 0 };
            seconds = 0;
            gameStarted = false;
            canFlip = true;
            pendingScore = null;

            clearInterval(timerInterval);

            document.getElementById('time').textContent = '0:00';
            document.getElementById('pairs').textContent = '0';
            document.getElementById('totalPairs').textContent = totalPairs;
            document.getElementById('player1Score').textContent = '0';
            document.getElementById('player2Score').textContent = '0';
            document.getElementById('winModal').classList.remove('show');
            document.getElementById('nameInputSection').style.display = 'none';

            updatePlayerUI();

            const emojis = allEmojis.slice(0, totalPairs);
            const cardPairs = [...emojis, ...emojis];

            for (let i = cardPairs.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [cardPairs[i], cardPairs[j]] = [cardPairs[j], cardPairs[i]];
            }

            const gameBoard = document.getElementById('gameBoard');
            gameBoard.innerHTML = '';

            cardPairs.forEach((emoji, index) => {
                const card = document.createElement('div');
                card.className = 'card';
                card.dataset.index = index;
                card.dataset.emoji = emoji;
                card.innerHTML = `
                    <div class="card-face card-back"></div>
                    <div class="card-face card-front">${emoji}</div>
                `;
                card.addEventListener('click', () => flipCard(card));
                gameBoard.appendChild(card);
                cards.push(card);
            });
        }

        function updatePlayerUI() {
            const p1Info = document.getElementById('player1Info');
            const p2Info = document.getElementById('player2Info');
            const turnIndicator = document.getElementById('turnIndicator');

            p1Info.classList.toggle('active', currentPlayer === 1);
            p2Info.classList.toggle('active', currentPlayer === 2);

            turnIndicator.className = 'turn-indicator player' + currentPlayer;

            if (config.players === 1) {
                turnIndicator.textContent = 'Your Turn';
            } else {
                turnIndicator.textContent = `Player ${currentPlayer}'s Turn`;
            }
        }

        function flipCard(card) {
            if (!canFlip) return;
            if (card.classList.contains('flipped')) return;
            if (card.classList.contains('matched')) return;
            if (flippedCards.length >= 2) return;

            if (!gameStarted) {
                gameStarted = true;
                timerInterval = setInterval(updateTimer, 1000);
            }

            card.classList.add('flipped');
            flippedCards.push(card);

            if (flippedCards.length === 2) {
                checkMatch();
            }
        }

        function checkMatch() {
            const [card1, card2] = flippedCards;
            const match = card1.dataset.emoji === card2.dataset.emoji;

            if (match) {
                card1.classList.add('matched', 'player' + currentPlayer);
                card2.classList.add('matched', 'player' + currentPlayer);
                matchedPairs++;
                scores[currentPlayer]++;

                document.getElementById('pairs').textContent = matchedPairs;
                document.getElementById('player' + currentPlayer + 'Score').textContent = scores[currentPlayer];

                flippedCards = [];

                if (matchedPairs === totalPairs) {
                    endGame();
                }
            } else {
                canFlip = false;
                setTimeout(() => {
                    card1.classList.remove('flipped');
                    card2.classList.remove('flipped');
                    flippedCards = [];
                    canFlip = true;

                    if (config.players === 2) {
                        currentPlayer = currentPlayer === 1 ? 2 : 1;
                        updatePlayerUI();
                    }
                }, 1000);
            }
        }

        function updateTimer() {
            seconds++;
            document.getElementById('time').textContent = formatTime(seconds);
        }

        function endGame() {
            clearInterval(timerInterval);
            const timeStr = formatTime(seconds);

            document.getElementById('finalTime').textContent = timeStr;
            document.getElementById('finalP1Score').textContent = scores[1] + ' pairs';
            document.getElementById('finalP2Score').textContent = scores[2] + ' pairs';

            const winTitle = document.getElementById('winTitle');
            const nameSection = document.getElementById('nameInputSection');

            if (config.players === 1) {
                winTitle.textContent = 'You Win!';
                winTitle.className = '';

                // Show name input immediately
                nameSection.style.display = 'block';
                pendingScore = { level: config.level, time: seconds };

                // Check high score in background (if Supabase loaded)
                if (typeof isHighScoreInDB === 'function') {
                    isHighScoreInDB('memory_match', seconds, config.level).then(isHigh => {
                        if (!isHigh) {
                            nameSection.style.display = 'none';
                            pendingScore = null;
                        }
                    }).catch(err => {
                        console.error('High score check failed:', err);
                    });
                }
            } else {
                nameSection.style.display = 'none';
                if (scores[1] > scores[2]) {
                    winTitle.textContent = 'Player 1 Wins!';
                    winTitle.className = 'player1-wins';
                } else if (scores[2] > scores[1]) {
                    winTitle.textContent = 'Player 2 Wins!';
                    winTitle.className = 'player2-wins';
                } else {
                    winTitle.textContent = "It's a Tie!";
                    winTitle.className = '';
                }
            }

            setTimeout(() => {
                document.getElementById('winModal').classList.add('show');
            }, 500);
        }
    </script>
</body>
</html>
