<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#e94560">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
    <title>Pokemon Type Battle - Mini Games Arcade</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: max(20px, env(safe-area-inset-top)) 20px 20px;
        }

        .header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .back-btn {
            color: #e94560;
            text-decoration: none;
            font-size: 1.5rem;
            padding: 10px 15px;
            border-radius: 10px;
            transition: background 0.2s;
        }

        .back-btn:hover { background: rgba(233, 69, 96, 0.2); }

        h1 { color: #fff; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3); }

        .screen { display: none; flex-direction: column; align-items: center; width: 100%; max-width: 500px; }
        .screen.active { display: flex; }

        /* Setup Screen */
        .setup-screen {
            background: rgba(255, 255, 255, 0.05);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            color: #fff;
        }

        .setup-screen h2 {
            margin-bottom: 20px;
            color: #ffcb05;
            text-shadow: 2px 2px 0 #3466af;
        }

        .type-chart {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .type-chart h3 { color: #4ecca3; margin-bottom: 10px; }

        .type-chart .matchup {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin: 8px 0;
            font-size: 0.95rem;
        }

        .type-chart .matchup img {
            width: 40px;
            height: 40px;
            image-rendering: pixelated;
        }

        .btn {
            padding: 15px 40px;
            font-size: 1.1rem;
            background: linear-gradient(145deg, #ffcb05, #cc9f00);
            color: #3466af;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(255, 203, 5, 0.4);
        }

        .btn-secondary { background: rgba(255, 255, 255, 0.2); color: white; }

        /* Pokemon Selection */
        .pokemon-select-screen h2 { color: #ffcb05; margin-bottom: 20px; }

        .pokemon-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .pokemon-option {
            background: rgba(255, 255, 255, 0.1);
            border: 3px solid transparent;
            border-radius: 15px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .pokemon-option:hover { background: rgba(255, 255, 255, 0.2); }
        .pokemon-option.selected { border-color: #ffcb05; background: rgba(255, 203, 5, 0.2); }

        .pokemon-option img {
            width: 80px;
            height: 80px;
            image-rendering: pixelated;
        }

        .pokemon-option .name {
            color: #fff;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .pokemon-option .type {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 10px;
            margin-top: 5px;
            display: inline-block;
        }

        .pokemon-option .type.fire { background: #f08030; color: #fff; }
        .pokemon-option .type.water { background: #6890f0; color: #fff; }
        .pokemon-option .type.grass { background: #78c850; color: #fff; }

        /* Battle Screen */
        .battle-info {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 15px;
            color: #fff;
            font-size: 1rem;
        }

        .battle-info span {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 14px;
            border-radius: 10px;
        }

        .battle-arena {
            background: linear-gradient(180deg, #87ceeb 0%, #90ee90 50%, #8b4513 100%);
            width: 100%;
            border-radius: 20px;
            padding: 20px;
            position: relative;
        }

        .trainer-area {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .pokemon-display {
            text-align: center;
            padding: 15px;
            border-radius: 15px;
            min-width: 130px;
        }

        .pokemon-display.player { background: rgba(52, 102, 175, 0.8); }
        .pokemon-display.opponent { background: rgba(233, 69, 96, 0.8); }

        .pokemon-sprite {
            width: 96px;
            height: 96px;
            image-rendering: pixelated;
            animation: bounce 1s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        .pokemon-name {
            color: #fff;
            font-weight: bold;
            font-size: 1rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            margin-top: 5px;
        }

        .hp-bar {
            width: 100%;
            height: 10px;
            background: #333;
            border-radius: 5px;
            margin-top: 8px;
            overflow: hidden;
        }

        .hp-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ecca3, #2ecc71);
            transition: width 0.5s ease;
            border-radius: 5px;
        }

        .hp-fill.low { background: linear-gradient(90deg, #f39c12, #e74c3c); }
        .hp-fill.critical { background: #e74c3c; animation: pulse 0.5s infinite; }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

        .vs-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -80%);
            font-size: 1.5rem;
            color: #ffcb05;
            text-shadow: 2px 2px 0 #3466af;
            font-weight: bold;
        }

        .battle-message {
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 12px;
            border-radius: 10px;
            text-align: center;
            font-size: 1rem;
            margin-bottom: 15px;
            border: 2px solid #ffcb05;
        }

        .move-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .move-btn {
            padding: 15px 10px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .move-btn:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .move-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .move-btn.fire { background: linear-gradient(145deg, #ff6b35, #f7931e); }
        .move-btn.water { background: linear-gradient(145deg, #3498db, #2980b9); }
        .move-btn.grass { background: linear-gradient(145deg, #27ae60, #1e8449); }
        .move-btn.normal { background: linear-gradient(145deg, #a0a0a0, #808080); }

        .move-btn img { width: 48px; height: 48px; image-rendering: pixelated; }
        .move-btn span { font-size: 0.85rem; color: #fff; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }

        .effect-overlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            display: none;
            justify-content: center;
            align-items: center;
            font-size: 4rem;
            border-radius: 20px;
            background: rgba(255,255,255,0.3);
        }

        .effect-overlay.show { display: flex; animation: effectFlash 0.6s ease; }

        @keyframes effectFlash {
            0% { opacity: 0; transform: scale(0.5); }
            50% { opacity: 1; transform: scale(1.2); }
            100% { opacity: 0; transform: scale(1); }
        }

        .game-buttons { display: flex; gap: 10px; margin-top: 15px; }

        .game-btn {
            padding: 10px 20px;
            font-size: 1rem;
            background: linear-gradient(145deg, #e94560, #c73e54);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
        }

        .game-btn:hover { transform: translateY(-2px); }
        .game-btn.secondary { background: rgba(255, 255, 255, 0.2); }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .modal.show { display: flex; }

        .modal-content {
            background: linear-gradient(145deg, #1a1a2e, #16213e);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            color: white;
            border: 3px solid #ffcb05;
            max-width: 400px;
            width: 90%;
        }

        .modal-content h2 { font-size: 1.8rem; margin-bottom: 15px; color: #ffcb05; }
        .modal-content h2.defeat { color: #e94560; }
        .modal-content .trophy { font-size: 3.5rem; margin-bottom: 10px; }

        .final-stats {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .final-stats p { margin: 5px 0; }

        .name-input-section { margin: 15px 0; }
        .name-input-section input {
            padding: 10px 15px;
            font-size: 1rem;
            border: 2px solid #ffcb05;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            text-align: center;
            width: 180px;
        }

        .name-input-section p { margin-bottom: 10px; color: #4ecca3; }

        .modal-buttons { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        .modal-buttons .btn { padding: 10px 20px; font-size: 1rem; }

        @media (max-width: 500px) {
            .pokemon-sprite { width: 64px; height: 64px; }
            .pokemon-option img { width: 60px; height: 60px; }
            .pokemon-grid { gap: 10px; }
            .move-btn img { width: 36px; height: 36px; }
            .move-btn { padding: 10px 5px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <a href="../index.html" class="back-btn">‚Üê</a>
        <h1>Pokemon Type Battle</h1>
    </div>

    <!-- Setup Screen -->
    <div class="screen setup-screen active" id="setupScreen">
        <h2>‚ö° Trainer Challenge ‚ö°</h2>

        <div class="type-chart">
            <h3>Type Matchups</h3>
            <div class="matchup">
                <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/4.png" alt="Fire">
                Fire beats
                <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/1.png" alt="Grass">
                Grass
            </div>
            <div class="matchup">
                <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/1.png" alt="Grass">
                Grass beats
                <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/7.png" alt="Water">
                Water
            </div>
            <div class="matchup">
                <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/7.png" alt="Water">
                Water beats
                <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/4.png" alt="Fire">
                Fire
            </div>
        </div>

        <p style="margin-bottom: 20px; color: #aaa;">
            Choose your Pokemon and battle through 10 trainers!
        </p>

        <button class="btn" id="startBtn">Choose Pokemon</button>
        <button class="btn btn-secondary" id="viewScoreboardBtn">Leaderboard</button>
    </div>

    <!-- Pokemon Selection Screen -->
    <div class="screen" id="selectScreen">
        <h2 style="color:#ffcb05;margin-bottom:15px;">Choose Your Pokemon!</h2>
        <div class="pokemon-grid" id="pokemonGrid"></div>
        <button class="btn" id="confirmPokemonBtn">Start Battle!</button>
        <button class="btn btn-secondary" id="backToSetupBtn">Back</button>
    </div>

    <!-- Battle Screen -->
    <div class="screen" id="gameScreen">
        <div class="battle-info">
            <span>Trainer: <span id="trainerNum">1</span>/10</span>
            <span>Score: <span id="score">0</span></span>
            <span>Streak: <span id="streak">0</span>üî•</span>
        </div>

        <div class="battle-arena">
            <div class="trainer-area">
                <div class="pokemon-display player">
                    <img class="pokemon-sprite" id="playerPokemon" src="" alt="">
                    <div class="pokemon-name" id="playerName">???</div>
                    <div class="hp-bar"><div class="hp-fill" id="playerHp" style="width:100%"></div></div>
                </div>

                <span class="vs-text">VS</span>

                <div class="pokemon-display opponent">
                    <img class="pokemon-sprite" id="opponentPokemon" src="" alt="">
                    <div class="pokemon-name" id="opponentName">???</div>
                    <div class="hp-bar"><div class="hp-fill" id="opponentHp" style="width:100%"></div></div>
                </div>
            </div>

            <div class="battle-message" id="battleMessage">Choose your attack type!</div>

            <div class="move-buttons" id="moveButtons">
                <!-- Move buttons are dynamically generated based on selected Pokemon -->
            </div>

            <div class="effect-overlay" id="effectOverlay"></div>
        </div>

        <div class="game-buttons">
            <button class="game-btn secondary" id="quitBtn">Quit</button>
        </div>
    </div>

    <!-- Victory Modal -->
    <div class="modal" id="victoryModal">
        <div class="modal-content">
            <div class="trophy">üèÜ</div>
            <h2 id="victoryTitle">Champion!</h2>
            <p id="victoryMessage">You defeated all trainers!</p>
            <div class="final-stats">
                <p>Final Score: <strong id="finalScore">0</strong></p>
                <p>Trainers Defeated: <strong id="trainersDefeated">0</strong></p>
                <p>Best Streak: <strong id="bestStreak">0</strong></p>
            </div>
            <div class="name-input-section" id="nameInputSection">
                <p>Enter your name:</p>
                <input type="text" id="playerNameInput" placeholder="Your name" maxlength="15">
            </div>
            <div class="modal-buttons">
                <button class="btn" id="playAgainBtn">Play Again</button>
                <button class="btn btn-secondary" id="menuBtn">Menu</button>
            </div>
        </div>
    </div>

    <!-- Scoreboard Modal -->
    <div class="modal" id="scoreboardModal">
        <div class="modal-content">
            <h2>üèÜ Leaderboard</h2>
            <div class="scoreboard-list" id="scoreboardList"></div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" id="closeScoreboardBtn">Close</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="../js/supabase-config.js"></script>
    <script src="../js/ad-manager.js"></script>
    <script>document.addEventListener('DOMContentLoaded', () => AdManager.init());</script>
    <script>
        const SPRITE_URL = 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/';

        const POKEMON = {
            fire: [
                { name: 'Charmander', id: 4, moves: [
                    { name: 'Ember', type: 'fire' },
                    { name: 'Scratch', type: 'normal' },
                    { name: 'Dragon Rage', type: 'fire' }
                ]},
                { name: 'Vulpix', id: 37, moves: [
                    { name: 'Flamethrower', type: 'fire' },
                    { name: 'Quick Attack', type: 'normal' },
                    { name: 'Fire Spin', type: 'fire' }
                ]},
                { name: 'Growlithe', id: 58, moves: [
                    { name: 'Fire Fang', type: 'fire' },
                    { name: 'Bite', type: 'normal' },
                    { name: 'Flame Wheel', type: 'fire' }
                ]}
            ],
            water: [
                { name: 'Squirtle', id: 7, moves: [
                    { name: 'Water Gun', type: 'water' },
                    { name: 'Tackle', type: 'normal' },
                    { name: 'Bubble Beam', type: 'water' }
                ]},
                { name: 'Psyduck', id: 54, moves: [
                    { name: 'Water Pulse', type: 'water' },
                    { name: 'Confusion', type: 'normal' },
                    { name: 'Hydro Pump', type: 'water' }
                ]},
                { name: 'Poliwag', id: 60, moves: [
                    { name: 'Bubble', type: 'water' },
                    { name: 'Pound', type: 'normal' },
                    { name: 'Water Sport', type: 'water' }
                ]}
            ],
            grass: [
                { name: 'Bulbasaur', id: 1, moves: [
                    { name: 'Vine Whip', type: 'grass' },
                    { name: 'Tackle', type: 'normal' },
                    { name: 'Razor Leaf', type: 'grass' }
                ]},
                { name: 'Oddish', id: 43, moves: [
                    { name: 'Absorb', type: 'grass' },
                    { name: 'Acid', type: 'normal' },
                    { name: 'Mega Drain', type: 'grass' }
                ]},
                { name: 'Bellsprout', id: 69, moves: [
                    { name: 'Vine Whip', type: 'grass' },
                    { name: 'Wrap', type: 'normal' },
                    { name: 'Razor Leaf', type: 'grass' }
                ]}
            ]
        };

        const TRAINERS = [
            { name: 'Bug Catcher', emoji: 'üß¢' },
            { name: 'Youngster', emoji: 'üë¶' },
            { name: 'Lass', emoji: 'üëß' },
            { name: 'Hiker', emoji: 'üßî' },
            { name: 'Swimmer', emoji: 'üèä' },
            { name: 'Ace Trainer', emoji: 'üéñÔ∏è' },
            { name: 'Ranger', emoji: 'üå≤' },
            { name: 'Veteran', emoji: '‚≠ê' },
            { name: 'Elite Four', emoji: 'üëë' },
            { name: 'Champion', emoji: 'üèÜ' }
        ];

        const EFFECTIVENESS = {
            fire: { fire: 0.5, water: 0.5, grass: 2, normal: 1 },
            water: { fire: 2, water: 0.5, grass: 0.5, normal: 1 },
            grass: { fire: 0.5, water: 2, grass: 0.5, normal: 1 },
            normal: { fire: 1, water: 1, grass: 1, normal: 1 }
        };

        function getSprite(id) { return SPRITE_URL + id + '.png'; }

        let state = {
            score: 0,
            currentTrainer: 0,
            playerHp: 100,
            opponentHp: 100,
            streak: 0,
            bestStreak: 0,
            opponentType: 'grass',
            canAttack: true,
            gameOver: false,
            selectedPokemon: null,
            pendingScore: null
        };

        // DOM
        const screens = {
            setup: document.getElementById('setupScreen'),
            select: document.getElementById('selectScreen'),
            game: document.getElementById('gameScreen')
        };

        function showScreen(name) {
            Object.values(screens).forEach(s => s.classList.remove('active'));
            screens[name].classList.add('active');
        }

        // Build Pokemon selection grid
        function buildPokemonGrid() {
            const grid = document.getElementById('pokemonGrid');
            grid.innerHTML = '';

            const allPokemon = [
                ...POKEMON.fire.slice(0, 3).map(p => ({...p, type: 'fire'})),
                ...POKEMON.water.slice(0, 3).map(p => ({...p, type: 'water'})),
                ...POKEMON.grass.slice(0, 3).map(p => ({...p, type: 'grass'}))
            ];

            allPokemon.forEach(pokemon => {
                const div = document.createElement('div');
                div.className = 'pokemon-option';
                div.dataset.id = pokemon.id;
                div.dataset.name = pokemon.name;
                div.dataset.type = pokemon.type;
                div.innerHTML = `
                    <img src="${getSprite(pokemon.id)}" alt="${pokemon.name}">
                    <div class="name">${pokemon.name}</div>
                    <span class="type ${pokemon.type}">${pokemon.type}</span>
                `;
                div.addEventListener('click', () => selectPokemon(div, pokemon));
                grid.appendChild(div);
            });
        }

        function selectPokemon(div, pokemon) {
            document.querySelectorAll('.pokemon-option').forEach(d => d.classList.remove('selected'));
            div.classList.add('selected');
            state.selectedPokemon = pokemon;
        }

        // Event listeners
        document.getElementById('startBtn').addEventListener('click', () => {
            buildPokemonGrid();
            showScreen('select');
        });

        document.getElementById('backToSetupBtn').addEventListener('click', () => showScreen('setup'));

        document.getElementById('confirmPokemonBtn').addEventListener('click', () => {
            if (!state.selectedPokemon) {
                alert('Please select a Pokemon!');
                return;
            }
            startGame();
        });

        document.getElementById('viewScoreboardBtn').addEventListener('click', showScoreboard);
        document.getElementById('closeScoreboardBtn').addEventListener('click', () => {
            document.getElementById('scoreboardModal').classList.remove('show');
        });

        document.getElementById('playAgainBtn').addEventListener('click', async () => {
            await saveScore();
            document.getElementById('victoryModal').classList.remove('show');
            showScreen('select');
        });

        document.getElementById('menuBtn').addEventListener('click', async () => {
            await saveScore();
            window.location.href = '../index.html';
        });

        document.getElementById('quitBtn').addEventListener('click', () => {
            window.location.href = '../index.html';
        });

        function renderMoveButtons() {
            const container = document.getElementById('moveButtons');
            container.innerHTML = '';

            const moves = state.selectedPokemon.moves;
            moves.forEach(move => {
                const btn = document.createElement('button');
                btn.className = `move-btn ${move.type}`;
                btn.dataset.type = move.type;
                btn.dataset.moveName = move.name;
                btn.innerHTML = `
                    <span style="font-size:1.5rem;">${getTypeEmoji(move.type)}</span>
                    <span>${move.name}</span>
                `;
                btn.addEventListener('click', () => handleAttack(move.type, move.name));
                container.appendChild(btn);
            });
        }

        function getTypeEmoji(type) {
            const emojis = { fire: 'üî•', water: 'üíß', grass: 'üåø', normal: '‚≠ê' };
            return emojis[type] || '‚≠ê';
        }

        function startGame() {
            state = {
                ...state,
                score: 0,
                currentTrainer: 0,
                playerHp: 100,
                opponentHp: 100,
                streak: 0,
                bestStreak: 0,
                canAttack: true,
                gameOver: false,
                pendingScore: null
            };

            // Set player Pokemon
            const playerImg = document.getElementById('playerPokemon');
            playerImg.src = getSprite(state.selectedPokemon.id);
            document.getElementById('playerName').textContent = state.selectedPokemon.name;
            document.getElementById('playerHp').style.width = '100%';

            // Render move buttons for selected Pokemon
            renderMoveButtons();

            showScreen('game');
            updateUI();
            nextOpponent();
        }

        function nextOpponent() {
            if (state.currentTrainer >= 10) {
                endGame(true);
                return;
            }

            const types = ['fire', 'water', 'grass'];
            state.opponentType = types[Math.floor(Math.random() * types.length)];
            state.opponentHp = 100;
            state.canAttack = true;

            const pokemonList = POKEMON[state.opponentType];
            const opponent = pokemonList[Math.floor(Math.random() * pokemonList.length)];
            state.opponentPokemon = opponent;
            const trainer = TRAINERS[state.currentTrainer];

            document.getElementById('opponentPokemon').src = getSprite(opponent.id);
            document.getElementById('opponentName').textContent = opponent.name;
            document.getElementById('opponentHp').style.width = '100%';
            updateHpBarClass('opponentHp', 100);

            document.getElementById('battleMessage').textContent =
                `${trainer.emoji} ${trainer.name} sent out ${opponent.name}!`;

            // Re-enable buttons
            enableMoveButtons(true);
            updateUI();
        }

        function enableMoveButtons(enabled) {
            document.querySelectorAll('.move-btn').forEach(btn => {
                btn.disabled = !enabled;
            });
        }

        function handleAttack(playerType, moveName) {
            if (!state.canAttack || state.gameOver) return;
            state.canAttack = false;
            enableMoveButtons(false);

            const playerName = state.selectedPokemon.name;
            const effectiveness = EFFECTIVENESS[playerType][state.opponentType];
            let damage = 0;
            let message = '';
            let effect = '';

            if (effectiveness === 2) {
                damage = 50 + Math.floor(Math.random() * 20);
                message = `${playerName} used ${moveName}! Super effective! üí•`;
                effect = 'üí•';
                state.streak++;
                state.score += Math.floor(100 * (1 + state.streak * 0.1));
            } else if (effectiveness === 0.5) {
                damage = 10 + Math.floor(Math.random() * 10);
                message = `${playerName} used ${moveName}... Not very effective üò∞`;
                effect = 'üò∞';
                state.streak = 0;
                state.score += 10;
            } else {
                damage = 25 + Math.floor(Math.random() * 15);
                message = `${playerName} used ${moveName}!`;
                effect = '‚ú®';
                state.score += 50;
            }

            if (state.streak > state.bestStreak) state.bestStreak = state.streak;

            state.opponentHp = Math.max(0, state.opponentHp - damage);

            showEffect(effect);
            document.getElementById('opponentHp').style.width = state.opponentHp + '%';
            updateHpBarClass('opponentHp', state.opponentHp);
            document.getElementById('battleMessage').textContent = message;
            updateUI();

            setTimeout(() => {
                if (state.playerHp <= 0) {
                    endGame(false);
                    return;
                }

                if (state.opponentHp <= 0) {
                    state.currentTrainer++;
                    const trainer = TRAINERS[state.currentTrainer - 1];
                    document.getElementById('battleMessage').textContent =
                        `${trainer.emoji} ${trainer.name} defeated! üéâ`;
                    state.score += 200;
                    updateUI();

                    setTimeout(() => nextOpponent(), 1500);
                } else {
                    // Opponent attacks back!
                    opponentAttack();
                }
            }, 1000);
        }

        function opponentAttack() {
            const opponent = state.opponentPokemon;
            const opponentName = opponent.name;
            const playerType = state.selectedPokemon.type;

            // Smart AI: 70% chance to pick best move, 30% random from available moves
            let chosenMove;
            if (Math.random() < 0.7) {
                // Find the most effective move against player
                let bestMove = opponent.moves[0];
                let bestEffectiveness = EFFECTIVENESS[bestMove.type][playerType] || 1;

                for (const move of opponent.moves) {
                    const eff = EFFECTIVENESS[move.type][playerType] || 1;
                    if (eff > bestEffectiveness) {
                        bestMove = move;
                        bestEffectiveness = eff;
                    }
                }
                chosenMove = bestMove;
            } else {
                chosenMove = opponent.moves[Math.floor(Math.random() * opponent.moves.length)];
            }

            const effectiveness = EFFECTIVENESS[chosenMove.type][playerType] || 1;
            let damage = 0;
            let message = '';
            let effect = '';

            if (effectiveness === 2) {
                damage = 25 + Math.floor(Math.random() * 15);
                message = `${opponentName} used ${chosenMove.name}! Super effective! üí•`;
                effect = 'üí•';
            } else if (effectiveness === 0.5) {
                damage = 5 + Math.floor(Math.random() * 5);
                message = `${opponentName} used ${chosenMove.name}... not very effective.`;
                effect = 'üòÖ';
            } else {
                damage = 12 + Math.floor(Math.random() * 8);
                message = `${opponentName} used ${chosenMove.name}!`;
                effect = '‚öîÔ∏è';
            }

            state.playerHp = Math.max(0, state.playerHp - damage);

            showEffect(effect);
            updatePlayerHp();
            document.getElementById('battleMessage').textContent = message;

            setTimeout(() => {
                if (state.playerHp <= 0) {
                    endGame(false);
                    return;
                }

                state.canAttack = true;
                enableMoveButtons(true);
                document.getElementById('battleMessage').textContent = "Choose your next attack!";
            }, 1200);
        }

        function updatePlayerHp() {
            const bar = document.getElementById('playerHp');
            bar.style.width = state.playerHp + '%';
            updateHpBarClass('playerHp', state.playerHp);
        }

        function updateHpBarClass(id, hp) {
            const bar = document.getElementById(id);
            bar.classList.remove('low', 'critical');
            if (hp <= 20) bar.classList.add('critical');
            else if (hp <= 50) bar.classList.add('low');
        }

        function showEffect(emoji) {
            const overlay = document.getElementById('effectOverlay');
            overlay.textContent = emoji;
            overlay.classList.add('show');
            setTimeout(() => overlay.classList.remove('show'), 600);
        }

        function updateUI() {
            document.getElementById('trainerNum').textContent = Math.min(state.currentTrainer + 1, 10);
            document.getElementById('score').textContent = Math.floor(state.score);
            document.getElementById('streak').textContent = state.streak;
        }

        function endGame(victory) {
            state.gameOver = true;
            enableMoveButtons(false);

            const modal = document.getElementById('victoryModal');
            const title = document.getElementById('victoryTitle');
            const message = document.getElementById('victoryMessage');
            const trophy = modal.querySelector('.trophy');

            document.getElementById('finalScore').textContent = Math.floor(state.score);
            document.getElementById('trainersDefeated').textContent = state.currentTrainer;
            document.getElementById('bestStreak').textContent = state.bestStreak;

            if (victory) {
                title.textContent = 'Pokemon Champion!';
                title.classList.remove('defeat');
                message.textContent = 'You defeated all trainers!';
                trophy.textContent = 'üèÜ';
                state.score += 500;
            } else {
                title.textContent = 'Defeated...';
                title.classList.add('defeat');
                message.textContent = 'Your Pokemon fainted!';
                trophy.textContent = 'üò¢';
            }

            state.pendingScore = Math.floor(state.score);
            document.getElementById('nameInputSection').style.display = 'block';

            AdManager.showInterstitial(() => {
                setTimeout(() => modal.classList.add('show'), 500);
            });
        }

        async function saveScore() {
            if (state.pendingScore && typeof addScoreToDB === 'function') {
                const name = document.getElementById('playerNameInput').value.trim() || 'Anonymous';
                await addScoreToDB('pokemon_battle', name, state.pendingScore);
                state.pendingScore = null;
                document.getElementById('playerNameInput').value = '';
            }
        }

        async function showScoreboard() {
            const container = document.getElementById('scoreboardList');
            container.innerHTML = '<p style="color:#888;padding:20px;">Loading...</p>';
            document.getElementById('scoreboardModal').classList.add('show');

            if (typeof getScoresFromDB !== 'function') {
                container.innerHTML = '<p style="color:#888;padding:20px;">Scoreboard unavailable</p>';
                return;
            }

            const scores = await getScoresFromDB('pokemon_battle');
            if (scores.length === 0) {
                container.innerHTML = '<p style="color:#888;padding:20px;">No scores yet!</p>';
                return;
            }

            let html = '<h3 style="color:#ffcb05;margin-bottom:10px;">Top 10</h3>';
            scores.forEach((entry, i) => {
                html += `<div style="display:flex;justify-content:space-between;padding:8px 10px;background:rgba(255,255,255,0.05);margin:3px 0;border-radius:5px;">
                    <span style="color:#e94560;font-weight:bold;width:25px;">#${i+1}</span>
                    <span style="flex:1;color:#fff;">${escapeHtml(entry.player_name)}</span>
                    <span style="color:#4ecca3;font-weight:bold;">${entry.score.toLocaleString()}</span>
                </div>`;
            });
            container.innerHTML = html;
        }
    </script>
</body>
</html>
