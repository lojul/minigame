<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#e94560">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
    <title>Paddle Battle - Mini Games Arcade</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #fff;
            padding-top: env(safe-area-inset-top);
        }

        .header {
            width: 100%;
            display: flex;
            align-items: center;
            padding: 15px 20px;
            gap: 15px;
        }

        .back-btn {
            color: #fff;
            text-decoration: none;
            font-size: 1.5rem;
            padding: 5px 12px;
            border-radius: 8px;
            transition: background 0.2s;
        }
        .back-btn:hover { background: rgba(233, 69, 96, 0.2); }

        .header h1 { color: #fff; font-size: 1.6rem; }

        /* Setup Screen */
        .setup-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            padding: 20px;
            width: 100%;
            max-width: 420px;
        }

        .setup-group { width: 100%; }
        .setup-group label {
            display: block;
            color: #4ecca3;
            font-size: 0.9rem;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .option-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .option-btn {
            flex: 1;
            padding: 12px 16px;
            background: rgba(255,255,255,0.08);
            border: 2px solid transparent;
            color: #aaa;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.2s;
            min-width: 80px;
        }
        .option-btn:hover { background: rgba(255,255,255,0.15); color: #fff; }
        .option-btn.selected { border-color: #e94560; background: rgba(233,69,96,0.2); color: #fff; }

        .start-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(145deg, #e94560, #c73e54);
            color: white;
            border: none;
            border-radius: 14px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            margin-top: 10px;
        }
        .start-btn:hover { transform: scale(1.02); }

        /* Game Screen */
        .game-screen { display: none; flex-direction: column; align-items: center; width: 100%; }
        .game-screen.active { display: flex; }

        .score-bar {
            display: flex;
            justify-content: space-around;
            align-items: center;
            width: 100%;
            max-width: 520px;
            padding: 10px 20px;
            font-size: 1rem;
        }

        .player-score {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        .player-score .name { color: #888; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; }
        .player-score .pts { font-size: 2.2rem; font-weight: bold; }
        .p1-score .pts { color: #e94560; }
        .p2-score .pts { color: #4ecca3; }

        .score-divider { color: #444; font-size: 1.8rem; }

        .serving-indicator {
            color: #f59e0b;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            min-height: 18px;
        }

        canvas {
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            background: #0a0a15;
            max-width: 100%;
            touch-action: none;
        }

        .game-info {
            color: #555;
            font-size: 0.8rem;
            margin-top: 8px;
            text-align: center;
        }

        /* Mobile touch zones ‚Äî shown only on touch devices */
        .touch-hint {
            display: none;
            color: #444;
            font-size: 0.75rem;
            margin-top: 6px;
            text-align: center;
        }
        @media (hover: none) { .touch-hint { display: block; } }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .modal.show { display: flex; }

        .modal-content {
            background: linear-gradient(145deg, #1a1a2e, #16213e);
            padding: 30px 24px;
            border-radius: 20px;
            text-align: center;
            color: white;
            border: 2px solid #e94560;
            width: 90%;
            max-width: 380px;
        }

        .modal-content h2 { font-size: 1.8rem; color: #e94560; margin-bottom: 8px; }
        .modal-content .winner-text { font-size: 1rem; color: #4ecca3; margin-bottom: 16px; }
        .modal-content .final-score { font-size: 2.5rem; font-weight: bold; margin: 10px 0; letter-spacing: 8px; }
        .final-score .p1c { color: #e94560; }
        .final-score .p2c { color: #4ecca3; }

        .name-input-section { margin: 16px 0; }
        .name-input-section p { color: #4ecca3; margin-bottom: 8px; font-size: 0.95rem; }
        .name-input-section input {
            padding: 10px 16px;
            font-size: 1rem;
            border: 2px solid #e94560;
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            color: #fff;
            text-align: center;
            width: 200px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .btn:hover { transform: scale(1.04); }
        .btn-primary { background: linear-gradient(145deg, #e94560, #c73e54); color: #fff; }
        .btn-secondary { background: rgba(255,255,255,0.15); color: #fff; }

        /* Scoreboard modal */
        .scoreboard-list { text-align: left; margin: 15px 0; }
        .score-entry {
            display: flex;
            justify-content: space-between;
            padding: 10px 15px;
            background: rgba(255,255,255,0.05);
            margin-bottom: 5px;
            border-radius: 8px;
        }
        .score-entry .rank { color: #e94560; font-weight: bold; width: 30px; }
        .score-entry .player-name { flex: 1; color: #fff; }
        .score-entry .score-value { color: #4ecca3; font-weight: bold; }
        .no-scores { color: #888; font-style: italic; padding: 20px; text-align: center; }

        /* Controls Card */
        .controls-card {
            width: 100%;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 14px 16px;
        }
        .controls-card .ctrl-title {
            color: #4ecca3;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }
        .ctrl-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 6px;
            font-size: 0.88rem;
        }
        .ctrl-row:last-child { margin-bottom: 0; }
        .ctrl-label {
            color: #888;
            width: 70px;
            flex-shrink: 0;
            font-size: 0.8rem;
        }
        .ctrl-keys {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            flex: 1;
        }
        .key {
            display: inline-block;
            background: rgba(255,255,255,0.12);
            border: 1px solid rgba(255,255,255,0.25);
            border-bottom: 2px solid rgba(255,255,255,0.15);
            border-radius: 5px;
            padding: 2px 7px;
            font-size: 0.78rem;
            color: #ddd;
            font-family: monospace;
        }
        .ctrl-divider {
            border: none;
            border-top: 1px solid rgba(255,255,255,0.07);
            margin: 8px 0;
        }
        .ctrl-note {
            color: #555;
            font-size: 0.78rem;
            margin-top: 6px;
        }

        @media (max-width: 540px) {
            .header h1 { font-size: 1.2rem; }
            .player-score .pts { font-size: 1.8rem; }
        }
    </style>
</head>
<body>
    <div class="header">
        <a href="../index.html" class="back-btn">‚Üê</a>
        <h1>üèì Paddle Battle</h1>
    </div>

    <!-- Setup Screen -->
    <div class="setup-screen" id="setupScreen">
        <div class="setup-group">
            <label>Players</label>
            <div class="option-buttons">
                <button class="option-btn selected" data-players="1">1 Player</button>
                <button class="option-btn" data-players="2">2 Players</button>
            </div>
        </div>

        <div class="setup-group" id="difficultyGroup">
            <label>AI Difficulty</label>
            <div class="option-buttons">
                <button class="option-btn" data-diff="easy">Easy</button>
                <button class="option-btn selected" data-diff="medium">Medium</button>
                <button class="option-btn" data-diff="hard">Hard</button>
            </div>
        </div>

        <div class="setup-group">
            <label>Win Condition</label>
            <div class="option-buttons">
                <button class="option-btn selected" data-pts="7">First to 7</button>
                <button class="option-btn" data-pts="11">First to 11</button>
                <button class="option-btn" data-pts="21">First to 21</button>
            </div>
        </div>

        <!-- Controls Reference -->
        <div class="controls-card" id="controlsCard">
            <div class="ctrl-title">Controls</div>

            <!-- 1-player controls (shown by default) -->
            <div id="ctrl1P">
                <div class="ctrl-row">
                    <span class="ctrl-label" style="color:#e94560;">You</span>
                    <div class="ctrl-keys">
                        <span class="key">W</span><span class="key">S</span>
                        <span style="color:#555;font-size:0.8rem;">or</span>
                        <span class="key">‚Üë</span><span class="key">‚Üì</span>
                        <span style="color:#555;font-size:0.8rem;">move</span>
                    </div>
                </div>
                <div class="ctrl-row">
                    <span class="ctrl-label" style="color:#e94560;">Serve</span>
                    <div class="ctrl-keys">
                        <span class="key">Space</span>
                        <span style="color:#555;font-size:0.8rem;">or click / tap</span>
                    </div>
                </div>
            </div>

            <!-- 2-player controls (hidden by default) -->
            <div id="ctrl2P" style="display:none;">
                <div class="ctrl-row">
                    <span class="ctrl-label" style="color:#e94560;">P1 (left)</span>
                    <div class="ctrl-keys">
                        <span class="key">W</span><span class="key">S</span>
                        <span style="color:#555;font-size:0.8rem;">or</span>
                        <span class="key">‚Üë</span><span class="key">‚Üì</span>
                    </div>
                </div>
                <hr class="ctrl-divider">
                <div class="ctrl-row">
                    <span class="ctrl-label" style="color:#4ecca3;">P2 (right)</span>
                    <div class="ctrl-keys">
                        <span class="key">I</span><span class="key">K</span>
                    </div>
                </div>
                <div class="ctrl-row">
                    <span class="ctrl-label" style="color:#888;">Serve</span>
                    <div class="ctrl-keys">
                        <span class="key">Space</span>
                        <span style="color:#555;font-size:0.8rem;">or click / tap</span>
                    </div>
                </div>
            </div>

            <p class="ctrl-note">üì± On mobile: drag left half (P1) ¬∑ drag right half (P2)</p>
        </div>

        <button class="start-btn" id="startBtn">Start Game</button>
        <button class="btn btn-secondary" id="viewScoreboardBtn" style="width:100%;">View Scoreboard</button>
    </div>

    <!-- Game Screen -->
    <div class="game-screen" id="gameScreen">
        <div class="score-bar">
            <div class="player-score p1-score">
                <div class="name" id="p1Name">Player 1</div>
                <div class="pts" id="p1Score">0</div>
            </div>
            <div style="display:flex;flex-direction:column;align-items:center;gap:4px;">
                <div class="score-divider">:</div>
                <div class="serving-indicator" id="servingIndicator"></div>
            </div>
            <div class="player-score p2-score">
                <div class="name" id="p2Name">AI</div>
                <div class="pts" id="p2Score">0</div>
            </div>
        </div>

        <canvas id="gameCanvas" width="480" height="320"></canvas>
        <button id="quitToMenuBtn" style="margin-top:8px;padding:8px 20px;background:rgba(255,255,255,0.12);border:1px solid rgba(255,255,255,0.2);color:#aaa;border-radius:8px;cursor:pointer;font-size:0.85rem;">Quit to Menu</button>

        <div class="touch-hint">Touch left half to move your paddle ¬∑ Touch right half for Player 2</div>
        <div class="game-info" id="gameInfo">Press Space or tap to serve</div>
    </div>

    <!-- Game Over Modal -->
    <div class="modal" id="gameOverModal">
        <div class="modal-content">
            <h2>Game Over!</h2>
            <div class="winner-text" id="winnerText"></div>
            <div class="final-score">
                <span class="p1c" id="modalP1Score">0</span>
                <span style="color:#555"> : </span>
                <span class="p2c" id="modalP2Score">0</span>
            </div>

            <div class="name-input-section" id="nameInputSection" style="display:none;">
                <p id="namePrompt">New High Score! Enter your name:</p>
                <input type="text" id="playerNameInput" placeholder="Your name" maxlength="15">
            </div>

            <div class="modal-buttons">
                <button class="btn btn-primary" id="playAgainBtn">Play Again</button>
                <button class="btn btn-secondary" id="watchAdBtn">Watch Ad for Bonus</button>
                <button class="btn btn-secondary" id="quitBtn">Quit</button>
            </div>
        </div>
    </div>

    <!-- Scoreboard Modal -->
    <div class="modal" id="scoreboardModal">
        <div class="modal-content">
            <h2 style="color:#4ecca3;">Leaderboard</h2>
            <p style="color:#888;font-size:0.85rem;margin-bottom:10px;">1-Player mode ¬∑ points scored</p>
            <div class="scoreboard-list" id="scoreboardList"></div>
            <button class="btn btn-secondary" id="closeScoreboardBtn" style="margin-top:10px;">Close</button>
        </div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="../js/supabase-config.js"></script>
    <script src="../js/ad-manager.js"></script>
    <script>document.addEventListener('DOMContentLoaded', () => AdManager.init());</script>
    <script>
        // ‚îÄ‚îÄ‚îÄ Config ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const CANVAS_W = 480;
        const CANVAS_H = 320;
        const PADDLE_W = 10;
        const PADDLE_H = 60;
        const BALL_SIZE = 8;
        const BALL_SPEED_INIT = 4;
        const BALL_SPEED_MAX = 12;
        const SPEED_INCREMENT = 0.25;

        const AI_SPEED = { easy: 2.2, medium: 3.4, hard: 5.0 };

        // ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        let config = { players: 1, diff: 'medium', winPts: 7 };
        let ball, paddleL, paddleR, scores, serving, gameRunning, animId, pendingScore;

        // Touch tracking
        const touches = {}; // identifier ‚Üí side ('left'|'right')
        let touchYLeft = null;
        let touchYRight = null;

        // Keyboard
        const keys = {};
        document.addEventListener('keydown', e => {
            keys[e.code] = true;
            if ((e.code === 'Space' || e.code === 'ArrowUp' || e.code === 'ArrowDown') && gameRunning)
                e.preventDefault();
            if (e.code === 'Space' && serving && gameRunning) serveBall();
        });
        document.addEventListener('keyup', e => { keys[e.code] = false; });

        // ‚îÄ‚îÄ‚îÄ Setup UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        document.querySelectorAll('[data-players]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('[data-players]').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                config.players = parseInt(btn.dataset.players);
                document.getElementById('difficultyGroup').style.display = config.players === 1 ? '' : 'none';
                document.getElementById('p2Name').textContent = config.players === 1 ? 'AI' : 'Player 2';
                document.getElementById('ctrl1P').style.display = config.players === 1 ? '' : 'none';
                document.getElementById('ctrl2P').style.display = config.players === 2 ? '' : 'none';
            });
        });

        document.querySelectorAll('[data-diff]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('[data-diff]').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                config.diff = btn.dataset.diff;
            });
        });

        document.querySelectorAll('[data-pts]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('[data-pts]').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                config.winPts = parseInt(btn.dataset.pts);
            });
        });

        document.getElementById('startBtn').addEventListener('click', startGame);

        // ‚îÄ‚îÄ‚îÄ Game Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function startGame() {
            document.getElementById('setupScreen').style.display = 'none';
            document.getElementById('gameScreen').classList.add('active');
            document.getElementById('p1Name').textContent = 'Player 1';
            document.getElementById('p2Name').textContent = config.players === 1 ? 'AI' : 'Player 2';

            scores = { l: 0, r: 0 };
            serving = true;
            gameRunning = true;
            pendingScore = null;

            paddleL = { x: 20, y: CANVAS_H / 2, dy: 0 };
            paddleR = { x: CANVAS_W - 20 - PADDLE_W, y: CANVAS_H / 2, dy: 0 };

            resetBall(1); // serve to player
            updateScoreDisplay();
            if (animId) cancelAnimationFrame(animId);
            gameLoop();
        }

        function resetBall(direction) {
            ball = {
                x: CANVAS_W / 2,
                y: CANVAS_H / 2,
                vx: 0,
                vy: 0,
                speed: BALL_SPEED_INIT,
            };
            serving = true;
            document.getElementById('gameInfo').textContent = 'Press Space or tap to serve';
            document.getElementById('servingIndicator').textContent =
                direction === 1 ? 'üèì Your serve' : (config.players === 1 ? 'üèì AI serves' : 'üèì P2 serves');
        }

        function serveBall() {
            if (!serving) return;
            serving = false;
            document.getElementById('gameInfo').textContent = '';
            document.getElementById('servingIndicator').textContent = '';
            const angle = (Math.random() * 40 - 20) * Math.PI / 180;
            const dir = Math.random() < 0.5 ? 1 : -1;
            ball.vx = dir * ball.speed * Math.cos(angle);
            ball.vy = ball.speed * Math.sin(angle);
        }

        // ‚îÄ‚îÄ‚îÄ Game Loop ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function gameLoop() {
            if (!gameRunning) return;
            update();
            draw();
            animId = requestAnimationFrame(gameLoop);
        }

        function update() {
            if (serving) {
                // Tap to serve on mobile
                movePaddles();
                return;
            }

            // Move ball
            ball.x += ball.vx;
            ball.y += ball.vy;

            // Top / bottom bounce
            if (ball.y - BALL_SIZE <= 0) { ball.y = BALL_SIZE; ball.vy = Math.abs(ball.vy); }
            if (ball.y + BALL_SIZE >= CANVAS_H) { ball.y = CANVAS_H - BALL_SIZE; ball.vy = -Math.abs(ball.vy); }

            // Left paddle collision
            if (ball.vx < 0 &&
                ball.x - BALL_SIZE <= paddleL.x + PADDLE_W &&
                ball.x + BALL_SIZE >= paddleL.x &&
                ball.y >= paddleL.y - PADDLE_H / 2 &&
                ball.y <= paddleL.y + PADDLE_H / 2) {
                ball.x = paddleL.x + PADDLE_W + BALL_SIZE;
                const relY = (ball.y - paddleL.y) / (PADDLE_H / 2);
                const bounceAngle = relY * 60 * Math.PI / 180;
                ball.speed = Math.min(ball.speed + SPEED_INCREMENT, BALL_SPEED_MAX);
                ball.vx = ball.speed * Math.cos(bounceAngle);
                ball.vy = ball.speed * Math.sin(bounceAngle);
            }

            // Right paddle collision
            if (ball.vx > 0 &&
                ball.x + BALL_SIZE >= paddleR.x &&
                ball.x - BALL_SIZE <= paddleR.x + PADDLE_W &&
                ball.y >= paddleR.y - PADDLE_H / 2 &&
                ball.y <= paddleR.y + PADDLE_H / 2) {
                ball.x = paddleR.x - BALL_SIZE;
                const relY = (ball.y - paddleR.y) / (PADDLE_H / 2);
                const bounceAngle = relY * 60 * Math.PI / 180;
                ball.speed = Math.min(ball.speed + SPEED_INCREMENT, BALL_SPEED_MAX);
                ball.vx = -ball.speed * Math.cos(bounceAngle);
                ball.vy = ball.speed * Math.sin(bounceAngle);
            }

            // Scoring
            if (ball.x < 0) {
                scores.r++;
                updateScoreDisplay();
                if (scores.r >= config.winPts) { endGame(); return; }
                resetBall(-1);
            }
            if (ball.x > CANVAS_W) {
                scores.l++;
                updateScoreDisplay();
                if (scores.l >= config.winPts) { endGame(); return; }
                resetBall(1);
            }

            movePaddles();
        }

        function movePaddles() {
            const speed = 5;

            // Left paddle ‚Äî keyboard (W/S) or touch left half
            if (keys['KeyW'] || keys['ArrowUp']) paddleL.y -= speed;
            if (keys['KeyS'] || keys['ArrowDown']) paddleL.y += speed;
            if (touchYLeft !== null) {
                const diff = touchYLeft - paddleL.y;
                paddleL.y += Math.sign(diff) * Math.min(Math.abs(diff), speed * 1.5);
            }

            // Right paddle ‚Äî keyboard (Up/Down) for 2-player; AI for 1-player; or touch right half
            if (config.players === 2) {
                if (keys['KeyI']) paddleR.y -= speed;
                if (keys['KeyK']) paddleR.y += speed;
            } else {
                // AI
                const aiSpeed = AI_SPEED[config.diff];
                const targetY = serving ? CANVAS_H / 2 : ball.y;
                const diff = targetY - paddleR.y;
                if (Math.abs(diff) > 4) paddleR.y += Math.sign(diff) * Math.min(Math.abs(diff) * 0.08 + aiSpeed * 0.5, aiSpeed);
            }
            if (touchYRight !== null) {
                const diff = touchYRight - paddleR.y;
                paddleR.y += Math.sign(diff) * Math.min(Math.abs(diff), speed * 1.5);
            }

            // Clamp paddles to canvas
            paddleL.y = Math.max(PADDLE_H / 2, Math.min(CANVAS_H - PADDLE_H / 2, paddleL.y));
            paddleR.y = Math.max(PADDLE_H / 2, Math.min(CANVAS_H - PADDLE_H / 2, paddleR.y));
        }

        // ‚îÄ‚îÄ‚îÄ Draw ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function draw() {
            ctx.fillStyle = '#0a0a15';
            ctx.fillRect(0, 0, CANVAS_W, CANVAS_H);

            // Centre line
            ctx.setLineDash([8, 8]);
            ctx.strokeStyle = 'rgba(255,255,255,0.08)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(CANVAS_W / 2, 0);
            ctx.lineTo(CANVAS_W / 2, CANVAS_H);
            ctx.stroke();
            ctx.setLineDash([]);

            // Table line
            ctx.fillStyle = 'rgba(255,255,255,0.06)';
            ctx.fillRect(0, CANVAS_H / 2 - 1, CANVAS_W, 2);

            // Paddles
            drawPaddle(paddleL, '#e94560');
            drawPaddle(paddleR, '#4ecca3');

            // Ball
            if (!serving) {
                ctx.beginPath();
                ctx.arc(ball.x, ball.y, BALL_SIZE, 0, Math.PI * 2);
                ctx.fillStyle = '#fff';
                ctx.shadowColor = '#fff';
                ctx.shadowBlur = 10;
                ctx.fill();
                ctx.shadowBlur = 0;
            } else {
                // Show ball on server's paddle
                const sx = ball.vx >= 0 ? paddleL.x + PADDLE_W + BALL_SIZE + 4 : paddleR.x - BALL_SIZE - 4;
                ctx.beginPath();
                ctx.arc(sx, paddleL.y, BALL_SIZE, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(255,255,255,0.4)';
                ctx.fill();
            }
        }

        function drawPaddle(paddle, color) {
            const r = 5;
            const x = paddle.x, y = paddle.y - PADDLE_H / 2, w = PADDLE_W, h = PADDLE_H;
            ctx.fillStyle = color;
            ctx.shadowColor = color;
            ctx.shadowBlur = 12;
            ctx.beginPath();
            ctx.moveTo(x + r, y);
            ctx.lineTo(x + w - r, y);
            ctx.arcTo(x + w, y, x + w, y + r, r);
            ctx.lineTo(x + w, y + h - r);
            ctx.arcTo(x + w, y + h, x + w - r, y + h, r);
            ctx.lineTo(x + r, y + h);
            ctx.arcTo(x, y + h, x, y + h - r, r);
            ctx.lineTo(x, y + r);
            ctx.arcTo(x, y, x + r, y, r);
            ctx.closePath();
            ctx.fill();
            ctx.shadowBlur = 0;
        }

        // ‚îÄ‚îÄ‚îÄ Score Display ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function updateScoreDisplay() {
            document.getElementById('p1Score').textContent = scores.l;
            document.getElementById('p2Score').textContent = scores.r;
        }

        // ‚îÄ‚îÄ‚îÄ End Game ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function endGame() {
            gameRunning = false;
            cancelAnimationFrame(animId);

            const p1Wins = scores.l >= config.winPts;
            const winnerName = p1Wins ? 'Player 1' : (config.players === 1 ? 'AI' : 'Player 2');

            document.getElementById('winnerText').textContent = winnerName + ' wins!';
            document.getElementById('modalP1Score').textContent = scores.l;
            document.getElementById('modalP2Score').textContent = scores.r;

            const nameSection = document.getElementById('nameInputSection');
            // Only save leaderboard entry for 1-player mode when human wins
            if (config.players === 1 && p1Wins) {
                pendingScore = scores.l;
                document.getElementById('namePrompt').textContent = 'New High Score! Enter your name:';
                nameSection.style.display = 'block';
                if (typeof isHighScoreInDB === 'function') {
                    isHighScoreInDB('table_tennis', scores.l).then(isHigh => {
                        if (!isHigh) { nameSection.style.display = 'none'; pendingScore = null; }
                    }).catch(() => {});
                }
            } else {
                nameSection.style.display = 'none';
                pendingScore = null;
            }

            AdManager.showInterstitial(() => {
                document.getElementById('gameOverModal').classList.add('show');
            });
        }

        async function savePlayerScore() {
            if (!pendingScore) return;
            const name = document.getElementById('playerNameInput').value.trim();
            if (!name || typeof addScoreToDB !== 'function') return;
            await addScoreToDB('table_tennis', name, pendingScore, null);
            pendingScore = null;
        }

        // ‚îÄ‚îÄ‚îÄ Touch Controls ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        canvas.addEventListener('touchstart', e => {
            e.preventDefault();
            for (const t of e.changedTouches) {
                const rect = canvas.getBoundingClientRect();
                const scaleX = CANVAS_W / rect.width;
                const cx = (t.clientX - rect.left) * scaleX;
                const cy = (t.clientY - rect.top) * (CANVAS_H / rect.height);
                if (cx < CANVAS_W / 2) { touchYLeft = cy; touches[t.identifier] = 'left'; }
                else { touchYRight = cy; touches[t.identifier] = 'right'; }
            }
            if (serving && gameRunning) serveBall();
        }, { passive: false });

        canvas.addEventListener('touchmove', e => {
            e.preventDefault();
            for (const t of e.changedTouches) {
                const rect = canvas.getBoundingClientRect();
                const cy = (t.clientY - rect.top) * (CANVAS_H / rect.height);
                if (touches[t.identifier] === 'left') touchYLeft = cy;
                else if (touches[t.identifier] === 'right') touchYRight = cy;
            }
        }, { passive: false });

        canvas.addEventListener('touchend', e => {
            for (const t of e.changedTouches) {
                if (touches[t.identifier] === 'left') touchYLeft = null;
                else if (touches[t.identifier] === 'right') touchYRight = null;
                delete touches[t.identifier];
            }
        });

        // Click/tap to serve on desktop
        canvas.addEventListener('click', () => { if (serving && gameRunning) serveBall(); });

        // ‚îÄ‚îÄ‚îÄ Responsive Canvas ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function resizeCanvas() {
            const maxW = Math.min(window.innerWidth - 24, 520);
            canvas.style.width = maxW + 'px';
            canvas.style.height = (maxW * CANVAS_H / CANVAS_W) + 'px';
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // ‚îÄ‚îÄ‚îÄ Modal Buttons ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        document.getElementById('playAgainBtn').addEventListener('click', async () => {
            await savePlayerScore();
            document.getElementById('gameOverModal').classList.remove('show');
            startGame();
        });

        document.getElementById('watchAdBtn').addEventListener('click', () => {
            AdManager.showRewarded(
                () => {
                    scores.l++;
                    document.getElementById('modalP1Score').textContent = scores.l;
                    if (pendingScore !== null) pendingScore = scores.l;
                },
                () => {}
            );
        });

        document.getElementById('quitBtn').addEventListener('click', async () => {
            await savePlayerScore();
            document.getElementById('gameOverModal').classList.remove('show');
            document.getElementById('gameScreen').classList.remove('active');
            document.getElementById('setupScreen').style.display = '';
        });

        document.getElementById('quitToMenuBtn').addEventListener('click', () => {
            gameRunning = false;
            cancelAnimationFrame(animId);
            window.location.href = '../index.html';
        });

        // ‚îÄ‚îÄ‚îÄ Scoreboard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        document.getElementById('viewScoreboardBtn').addEventListener('click', () => {
            renderScoreboard();
            document.getElementById('scoreboardModal').classList.add('show');
        });

        document.getElementById('closeScoreboardBtn').addEventListener('click', () => {
            document.getElementById('scoreboardModal').classList.remove('show');
        });

        async function renderScoreboard() {
            const list = document.getElementById('scoreboardList');
            list.innerHTML = '<p class="no-scores">Loading‚Ä¶</p>';
            if (typeof getScoresFromDB !== 'function') {
                list.innerHTML = '<p class="no-scores">Scoreboard unavailable</p>';
                return;
            }
            const scores = await getScoresFromDB('table_tennis', null);
            if (!scores || scores.length === 0) {
                list.innerHTML = '<p class="no-scores">No scores yet. Be the first!</p>';
                return;
            }
            list.innerHTML = scores.map((e, i) => `
                <div class="score-entry">
                    <span class="rank">#${i + 1}</span>
                    <span class="player-name">${e.player_name}</span>
                    <span class="score-value">${e.score} pts</span>
                </div>`).join('');
        }

        // Draw initial idle state
        ctx.fillStyle = '#0a0a15';
        ctx.fillRect(0, 0, CANVAS_W, CANVAS_H);
        ctx.fillStyle = 'rgba(255,255,255,0.15)';
        ctx.font = 'bold 48px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('üèì', CANVAS_W / 2, CANVAS_H / 2 + 18);
    </script>
    <script>
      if ('serviceWorker' in navigator)
        navigator.serviceWorker.register('/sw.js').catch(console.error);
    </script>
</body>
</html>
